name: Deploy

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Extract environment and image values
      id: extract
      run: |
        PR_BODY=$(jq -r '.pull_request.body' $GITHUB_EVENT_PATH)
        ENVIRONMENT=$(echo "$PR_BODY" | grep -oP '(?<=\[x\] ).*')
        
        if [[ "$ENVIRONMENT" == "Dev" ]]; then
          AP_IMAGE=$(echo "$PR_BODY" | grep -oP '(?<=Dev Environment.*AP Region:.*Image:).*' | head -n 1)
          EU_IMAGE=$(echo "$PR_BODY" | grep -oP '(?<=Dev Environment.*EU Region:.*Image:).*' | head -n 1)
          US_IMAGE=$(echo "$PR_BODY" | grep -oP '(?<=Dev Environment.*US Region:.*Image:).*' | head -n 1)
        fi

        echo "::set-output name=environment::$ENVIRONMENT"
        echo "::set-output name=ap_image::$AP_IMAGE"
        echo "::set-output name=eu_image::$EU_IMAGE"
        echo "::set-output name=us_image::$US_IMAGE"

    - name: Deploy to Dev
      if: steps.extract.outputs.environment == 'Dev'
      run: |
        echo "Deploying to Dev environment"
        echo "AP Region Image: ${{ steps.extract.outputs.ap_image }}"
        echo "EU Region Image: ${{ steps.extract.outputs.eu_image }}"
        echo "US Region Image: ${{ steps.extract.outputs.us_image }}"
        # Add your deployment script/commands here
